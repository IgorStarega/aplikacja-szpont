name: Tests & Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Rƒôczne uruchamianie

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8

    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Test with pytest
      run: |
        pytest tests/ -v --tb=short
      continue-on-error: true

    - name: Generate coverage report
      run: |
        pytest tests/ --cov=src --cov-report=xml --cov-report=html
      continue-on-error: true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
      continue-on-error: true

  build:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable with PyInstaller
      run: |
        pyinstaller build.spec
      env:
        PYTHONIOENCODING: utf-8

    - name: Verify build
      run: |
        if (Test-Path "dist/AktualizatorStrony.exe") {
          Write-Host "‚úÖ Build successful: AktualizatorStrony.exe"
          $file = Get-Item "dist/AktualizatorStrony.exe"
          Write-Host "Name: $($file.Name)"
          Write-Host "Size: $([math]::Round($file.Length / 1MB, 2)) MB"
          Write-Host "Date: $($file.LastWriteTime)"
        } else {
          Write-Host "‚ùå Build failed: executable not found"
          exit 1
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/AktualizatorStrony.exe
        retention-days: 30
        compression-level: 9
        if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: windows-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: dist/

    - name: Verify downloaded artifacts
      run: |
        Write-Host "Contents of dist/:"
        Get-ChildItem -Path dist/ -Recurse | Format-Table Name, Length, LastWriteTime

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref_name }}
        name: Aktualizator Strony ${{ github.ref_name }}
        body: |
          ## üöÄ Aktualizator Strony ${{ github.ref_name }}
          
          ### üì¶ Pobierz i Uruchom
          1. Pobierz `AktualizatorStrony.exe`
          2. Uruchom plik (nie wymaga instalacji)
          3. Gotowe!
          
          ### üìã Zmiany w tej wersji
          Zobacz [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) dla szczeg√≥≈Ç√≥w.
          
          ### ‚öôÔ∏è Wymagania systemowe
          - **System:** Windows 10/11 (64-bit)
          - **RAM:** 512 MB minimum
          - **Dysk:** 50 MB wolnego miejsca
          - **Internet:** Do pobierania aktualizacji
          
          ### üé® Funkcje v5.2
          - ‚úÖ Ikona aplikacji na pasku zada≈Ñ
          - ‚úÖ Auto-update z GitHub
          - ‚úÖ Docker support
          - ‚úÖ Mobile API
          - ‚úÖ PyInstaller standalone build
          
          ### üìñ Dokumentacja
          - [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [TODO.md](https://github.com/${{ github.repository }}/blob/main/TODO.md)
          
          ### üêõ Zg≈Çaszanie b≈Çƒôd√≥w
          Znalaz≈Çe≈õ b≈ÇƒÖd? [Zg≈Ço≈õ issue](https://github.com/${{ github.repository }}/issues/new)
          
          ### üí¨ Support
          - **Issues:** [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          - **Discussions:** [GitHub Discussions](https://github.com/${{ github.repository }}/discussions)
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          dist/AktualizatorStrony.exe

